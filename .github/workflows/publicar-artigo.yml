      - name: Gerar post e atualizar index
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const issue = context.payload.issue;
            const body = issue.body || '';

            function pick(label){
              const re = new RegExp(`###\\s+${label}\\s+([\\s\\S]*?)(?=\\n###\\s+|$)`, 'i');
              const m = body.match(re);
              return m ? m[1].trim() : '';
            }

            // Campos do formulário (Issue template)
            const title = pick('Título');
            const author = pick('Autor');
            const dateRaw = pick('Data') || pick('Data (AAAA-MM-DD)');
            const category = pick('Categoria');
            let excerpt = pick('Resumo') || pick('Resumo (1–2 frases)');
            const text = pick('Texto do artigo');

            if(!title || !author || !category || !text){
              core.setFailed('Campos obrigatórios ausentes (Título/Autor/Categoria/Texto).');
              return;
            }

            // Remove "1–2 frases" e variações do resumo
            excerpt = (excerpt || '')
              .replace(/\( ?1\s*[–-]\s*2\s*frases ?\)\s*/ig, '')
              .replace(/^1\s*[–-]\s*2\s*frases\s*[:\-–]\s*/ig, '')
              .trim();

            if(!excerpt){
              // fallback: gera um resumo curto do texto (primeira linha)
              excerpt = text.trim().split('\n').find(l => l.trim())?.trim() || '';
              excerpt = excerpt.slice(0, 160);
            }

            function slugify(str){
              return str.normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                .toLowerCase().trim()
                .replace(/[^a-z0-9\s-]/g,'')
                .replace(/\s+/g,'-')
                .replace(/-+/g,'-');
            }

            // Converte dateRaw para ISO AAAA-MM-DD
            function toISODate(input){
              const s = (input || '').trim();

              // já está em ISO?
              const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
              if(iso) return `${iso[1]}-${iso[2]}-${iso[3]}`;

              // formato BR dd/mm/aaaa
              const br = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
              if(br) return `${br[3]}-${br[2]}-${br[1]}`;

              // se vier só números tipo 20251228
              const num = s.match(/^(\d{4})(\d{2})(\d{2})$/);
              if(num) return `${num[1]}-${num[2]}-${num[3]}`;

              // fallback: hoje (UTC)
              const d = new Date();
              const yyyy = d.getUTCFullYear();
              const mm = String(d.getUTCMonth()+1).padStart(2,'0');
              const dd = String(d.getUTCDate()).padStart(2,'0');
              return `${yyyy}-${mm}-${dd}`;
            }

            const date = toISODate(dateRaw);

            function esc(s){
              return s
                .replaceAll('&','&amp;')
                .replaceAll('<','&lt;')
                .replaceAll('>','&gt;');
            }

            function textToHtml(t){
              const parts = t.trim().split(/\n\s*\n/g).map(p => p.trim()).filter(Boolean);
              return parts.map(p => `<p>${esc(p).replaceAll('\n','<br>')}</p>`).join('');
            }

            const slug = `${slugify(title)}-${issue.number}`;
            const post = {
              slug, title, date, category, author, excerpt,
              html: textToHtml(text)
            };

            if(!fs.existsSync('posts')) fs.mkdirSync('posts');
            fs.writeFileSync(`posts/${slug}.json`, JSON.stringify(post, null, 2), 'utf8');

            const indexPath = 'posts/index.json';
            let list = [];
            if(fs.existsSync(indexPath)){
              try { list = JSON.parse(fs.readFileSync(indexPath, 'utf8')); } catch(e) {}
            }

            // evita duplicar
            list = list.filter(p => p.slug !== slug);

            list.push({ slug, title, date, category, author, excerpt });

            // ordena por data desc
            list.sort((a,b) => (b.date||'').localeCompare(a.date||''));

            fs.writeFileSync(indexPath, JSON.stringify(list, null, 2), 'utf8');
