name: Publicar artigo a partir de Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: read

jobs:
  publish:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'novo-artigo')

    steps:
      - uses: actions/checkout@v4

      - name: Gerar post
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const body = issue.body || '';

            function pick(label){
              const re = new RegExp(`###\\s+${label}\\s+([\\s\\S]*?)(?=\\n###\\s+|$)`, 'i');
              const m = body.match(re);
              return m ? m[1].trim() : '';
            }

            const title = pick('Título');
            const author = pick('Autor');
            const date = pick('Data');
            const category = pick('Categoria');
            const excerpt = pick('Resumo');
            const text = pick('Texto do artigo');

            if(!title || !author || !date || !category || !excerpt || !text){
              core.setFailed('Campos obrigatórios ausentes.');
              return;
            }

            const slug = title
              .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
              .toLowerCase().trim()
              .replace(/[^a-z0-9\s-]/g,'')
              .replace(/\s+/g,'-')
              .replace(/-+/g,'-') + '-' + issue.number;

            const html = text
              .trim()
              .split(/\n\s*\n/g)
              .map(p => `<p>${p.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\n','<br>')}</p>`)
              .join('');

            const post = { slug, title, date, category, author, excerpt, html };

            if(!fs.existsSync('posts')) fs.mkdirSync('posts');

            fs.writeFileSync(`posts/${slug}.json`, JSON.stringify(post, null, 2));

            const indexPath = 'posts/index.json';
            let list = [];
            if(fs.existsSync(indexPath)){
              try { list = JSON.parse(fs.readFileSync(indexPath)); } catch(e){}
            }

            list.push({ slug, title, date, category, author, excerpt });
            list.sort((a,b) => (b.date||'').localeCompare(a.date||''));

            fs.writeFileSync(indexPath, JSON.stringify(list, null, 2));

      - name: Commit e push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add posts
          git commit -m "Publica artigo via Issue"
          git push
